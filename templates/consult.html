{% extends "layout.html" %}
{% block title %}Consult a Lawyer{% endblock %}

{% block content %}
<div class="container d-flex flex-column" style="height: 85vh;">
    <div class="card flex-grow-1 d-flex flex-column">
        <div class="card-header text-center">
            <h4>AI Legal Consultant (Nyay Mitra)</h4>
        </div>
        <div id="chat-box" class="card-body chat-box flex-grow-1" style="overflow-y: auto;">
            <div class="message ai-message">
                <div class="avatar">‚öñÔ∏è</div>
                <div class="msg-bubble">
                    Hello! I am Nyay Mitra, your AI legal assistant. How can I help you today? Please describe your situation.
                </div>
            </div>
        </div>
        <div class="card-footer chat-input-container">
            <form id="chat-form" class="d-flex">
                <input type="text" id="user-input" class="form-control" placeholder="Type your message here..." autocomplete="off">
                <button type="submit" class="btn btn-neon ms-2">Send</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const messageText = userInput.value.trim();
        if (messageText === '') return;

        appendMessage(messageText, 'user');
        userInput.value = '';
        appendMessage('<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>', 'ai', true);

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: messageText })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            
            removeThinkingIndicator();
            appendMessage(data.response, 'ai');

        } catch (error) {
            removeThinkingIndicator();
            appendMessage('Sorry, an error occurred. Please try again.', 'ai');
            console.error('Error:', error);
        }
    });

    function appendMessage(text, sender, isThinking = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender + '-message');
        if (isThinking) {
            messageDiv.id = 'thinking-indicator';
        }

        const avatar = document.createElement('div');
        avatar.classList.add('avatar');
        avatar.textContent = sender === 'user' ? 'üë§' : '‚öñÔ∏è';
        messageDiv.appendChild(avatar);

        const bubbleDiv = document.createElement('div');
        bubbleDiv.classList.add('msg-bubble');
        
        // --- THIS IS THE KEY FIX ---
        // Using innerHTML to render HTML tags sent by the AI
        bubbleDiv.innerHTML = text; 
        // --- END OF FIX ---

        messageDiv.appendChild(bubbleDiv);
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeThinkingIndicator() {
        const indicator = document.getElementById('thinking-indicator');
        if (indicator) {
            indicator.remove();
        }
    }
</script>
{% endblock %}
